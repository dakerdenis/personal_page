{% extends "cabinet/base.html" %}
{% block title %}Həkimlər — {{ speciality_id }}{% endblock %}

{% block head_extra %}
<style>

</style>
{% endblock %}

{% block content %}
<div class="hdr">
  <a class="back" href="{% url 'cabinet_doctors' %}">⬅ Geri</a>
  <h2 style="margin:0">İxtisas: {{ speciality_id }}</h2>
</div>

<div class="toolbar">
  <input id="q" type="text" placeholder="Həkim üzrə axtarış... (ad, iş yeri)">
  <button id="clear">Təmizlə</button>
</div>

<div id="err" class="msg-error" style="display:none;"></div>
<div id="empty" class="muted" style="display:none;">Bu ixtisas üzrə həkim tapılmadı.</div>
<div id="list" class="grid"></div>
{% endblock %}

{% block body_scripts %}
<script>
  (function () {
    const list = document.getElementById('list');
    const err = document.getElementById('err');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const clear = document.getElementById('clear');
    const specialityId = "{{ speciality_id|escapejs }}";

    let raw = [];
    let view = [];

    function imgSrc(base64) {
      if (!base64) return "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='%23f3f4f6'/><text x='50%' y='50%' font-size='10' text-anchor='middle' fill='%239ca3af' dy='.3em'>no photo</text></svg>";
      return "data:image/jpeg;base64," + base64;
    }



    function card(d) {
      const name = d.NAME || '—';
      const place = d.WORKPLACE_NAME || '';
      const id = d.CUSTOMER_ID || '';
      // НЕ посылаем base64 в URL
      const q = `?n=${encodeURIComponent(name)}&w=${encodeURIComponent(place)}`;

      return `
  <a class="card" href="/doctors/${encodeURIComponent(specialityId)}/${encodeURIComponent(id)}/">
    <img alt="" src="${imgSrc(d.FILE_CONTENT)}">
    <div>
      <p class="name">${name}</p>
      <p class="muted">İş yeri: ${place || '—'}</p>
      <p class="muted">ID: ${id}</p>
    </div>
  </a>
`;
    }


    function render(items) {
      if (!items || !items.length) {
        list.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      list.innerHTML = items.map(card).join('');
    }

    function applyFilter() {
      const term = (q.value || '').trim().toLowerCase();
      if (!term) {
        view = raw.slice();
      } else {
        view = raw.filter(d =>
          (d.NAME || '').toLowerCase().includes(term) ||
          (d.WORKPLACE_NAME || '').toLowerCase().includes(term)
        );
      }
      render(view);
    }

    q.addEventListener('input', applyFilter);
    clear.addEventListener('click', () => { q.value = ''; applyFilter(); });

    // загрузка
    fetch("{% url 'api_doctors_by_speciality' speciality_id=speciality_id %}")
      .then(r => r.json())
      .then(json => {
        if (!json.ok) throw new Error(json.error || 'Xəta');
        const arr = Array.isArray(json.doctors) ? json.doctors : [];
        raw = arr;
        applyFilter();
      })
      .catch(e => {
        err.style.display = 'block';
        err.textContent = 'Məlumat yüklənmədi: ' + (e.message || '');
      });

  })();
</script>
{% endblock %}