{% extends "cabinet/base.html" %}
{% block title %}Həkimlər — A-Group{% endblock %}

{% block head_extra %}
<style>

</style>
{% endblock %}

{% block content %}
<section id="doctors">
  <h2 class="doctors_desc">Həkimlər</h2>

  <div class="search_row">
    <input id="q" type="text" placeholder="İxtisas üzrə axtarış...">
    <button id="clear">Təmizlə</button>
  </div>

  <div id="err" class="msg-error" style="display:none;"></div>
  <div id="empty" class="muted" style="display:none;">Məlumat tapılmadı</div>
  <div id="list" class="speciality_grid"></div>
</section>

<!-- зарезервируем контейнер под будущие детали -->
<div id="doctor-popup" class="popup" style="display:none;"></div>
{% endblock %}

{% block body_scripts %}
<script>
  (function () {
    const list = document.getElementById('list');
    const errBox = document.getElementById('err');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const clear = document.getElementById('clear');

    let raw = [];   // исходный список SPECIALITIES
    let view = [];  // отфильтрованный

    function card(item) {
      const id = item.SPECIALITY_ID || '';
      const name = item.SPECIALITY_NAME || '';
      return `
      <div class="doctor_card" data-id="${id}">
        <img src="https://a-group.az/assets/images/healthicons_doctor-male-outline.svg" alt="">
        <div>
          <div style="font-weight:600">${name}</div>
        </div>
      </div>
    `;
    }

    function render(items) {
      if (!items || !items.length) {
        list.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      list.innerHTML = items.map(card).join('');
      list.querySelectorAll('.doctor_card').forEach(el => {
        el.addEventListener('click', () => {
          const specialityId = el.getAttribute('data-id');
          window.location.href = `/doctors/${encodeURIComponent(specialityId)}/`;
        });
      });

    }

    function applyFilter() {
      const term = (q.value || '').trim().toLowerCase();
      if (!term) {
        view = raw.slice();
      } else {
        view = raw.filter(it => (it.SPECIALITY_NAME || '').toLowerCase().includes(term));
      }
      render(view);
    }

    q.addEventListener('input', applyFilter);
    clear.addEventListener('click', () => { q.value = ''; applyFilter(); });

    // загрузка
    fetch('{% url "api_specialities" %}')
      .then(r => r.json())
      .then(json => {
        if (!json.ok) throw new Error(json.error || 'Xəta');
        raw = Array.isArray(json.specialities) ? json.specialities : [];
        applyFilter();
      })
      .catch(err => {
        errBox.style.display = 'block';
        errBox.textContent = 'Məlumat yüklənmədi: ' + (err.message || '');
      });

  })();
</script>
{% endblock %}